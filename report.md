# 车道线检测实验报告

## 实验目的

使用传统计算机视觉方法（霍夫变换）实现车道线检测，掌握边缘检测、感兴趣区域提取、直线检测等基本图像处理技术。

## 实验原理

### 1. Canny 边缘检测

Canny 边缘检测是一种多阶段算法，用于检测图像中的边缘：

- **高斯滤波**：首先对图像进行高斯模糊，减少噪声
- **计算梯度**：使用 Sobel 算子计算图像的梯度幅值和方向
- **非极大值抑制**：细化边缘，只保留梯度幅值最大的点
- **双阈值检测**：
  - 高阈值：强边缘，直接保留
  - 低阈值：弱边缘，只有与强边缘连接时才保留
- **边缘连接**：通过滞后阈值处理，连接断开的边缘

**作用**：将车道线从图像中提取出来，形成二值边缘图。

### 2. ROI（感兴趣区域）遮罩

在车道线检测中，我们只关心道路区域，不需要处理天空、建筑物等无关区域。

**原理**：

- 创建梯形遮罩，保留下半部分道路区域
- 使用 `cv2.fillPoly` 填充多边形区域
- 通过 `cv2.bitwise_and` 应用遮罩

**作用**：

- 减少计算量
- 排除干扰（如天空中的线条、建筑物边缘等）
- 提高检测准确率

### 3. HoughLinesP（概率霍夫变换）

霍夫变换是一种检测几何形状的方法，概率霍夫变换是其改进版本。

**原理**：

- 在边缘图像中，每个边缘点可能属于多条直线
- 在参数空间（ρ-θ 空间）中，属于同一条直线的点会形成峰值
- 概率霍夫变换随机采样边缘点，找到满足条件的线段

**参数说明**：

- `threshold`：累加器阈值，检测直线所需的最少交点数量
- `minLineLength`：线段最小长度，过滤太短的线段
- `maxLineGap`：线段间最大间隙，小于此值的线段可连接成一条线

**作用**：从边缘图像中检测出直线段，这些线段可能是车道线的一部分。

### 4. 斜率筛选与车道线分类

**原理**：

- 计算每条线段的斜率：`slope = (y2 - y1) / (x2 - x1)`
- 在图像坐标系中（y 向下）：
  - 负斜率：左车道线（从左上到右下）
  - 正斜率：右车道线（从左下到右上）
- 过滤接近水平的线（`abs(slope) < threshold`）

**作用**：将检测到的线段分为左右车道线候选。

### 5. 线段聚合拟合

**原理**：

- 收集同一侧的所有线段端点
- 使用 `np.polyfit` 进行线性拟合（一次多项式）
- 由于车道线接近垂直，使用 y 作为自变量，x 作为因变量
- 计算拟合直线在图像范围内的端点

**作用**：将多条短线段聚合成一条完整的车道线。

## 实验流程

1. **图像预处理**

   - 读取输入图像
   - 转换为灰度图
   - 高斯滤波降噪

2. **边缘检测**

   - Canny 边缘检测，得到二值边缘图

3. **ROI 提取**

   - 创建梯形遮罩
   - 应用遮罩，只保留下半部分道路区域

4. **直线检测**

   - 使用 HoughLinesP 检测直线段

5. **车道线筛选**

   - 计算每条线段的斜率
   - 过滤接近水平的线
   - 分为左右车道线候选

6. **线段聚合**

   - 对左右车道线分别进行线性拟合
   - 得到代表车道线的直线

7. **结果绘制**
   - 在原图上绘制检测到的车道线
   - 保存结果图像

## 参数影响分析

### Canny 阈值（`--canny1`, `--canny2`）

- **低阈值过低**：检测到过多噪声边缘，后续处理困难
- **低阈值过高**：可能丢失部分车道线边缘
- **高阈值过低**：边缘不连续，线段断裂
- **高阈值过高**：只检测到强边缘，可能漏检

**建议**：通常保持比例 1:3（如 50:150），根据图像对比度调整。

### Hough 参数

**`threshold`（累加器阈值）**：

- 值越大：检测到的线段越少，但更可靠
- 值越小：检测到的线段越多，但可能包含噪声

**`minLineLength`（最小线段长度）**：

- 值越大：过滤掉更多短线段，减少噪声
- 值越小：保留更多线段，但可能包含碎片

**`maxLineGap`（最大间隙）**：

- 值越大：更多断开的线段被连接
- 值越小：只连接距离很近的线段

**建议**：根据图像分辨率和车道线清晰度调整。

### ROI 参数（`--roi_top_ratio`）

- **值越大**（接近 1）：保留更多区域，可能包含干扰
- **值越小**（接近 0）：保留区域太少，可能丢失部分车道线

**建议**：通常 0.5-0.7 之间，根据图像视角调整。

### 斜率阈值（`--slope_thresh`）

- **值越大**：只保留更陡的线，过滤更多接近水平的线
- **值越小**：保留更多线，但可能包含非车道线

**建议**：通常 0.3-0.7 之间，根据车道线角度调整。

## 局限与改进方向

### 当前方法的局限

1. **光照条件敏感**

   - 强光、阴影、夜间等条件下，边缘检测效果差
   - 改进：自适应阈值、图像增强

2. **车道线遮挡**

   - 车辆、行人遮挡车道线时无法检测
   - 改进：使用多帧信息、预测模型

3. **弯道处理**

   - 当前方法假设车道线是直线，弯道效果差
   - 改进：使用曲线拟合（二次或三次多项式）、分段直线拟合

4. **车道线不连续**

   - 虚线车道线可能检测不完整
   - 改进：增大 `maxLineGap`，使用更智能的聚合方法

5. **复杂场景**

   - 多条车道、变道、路口等复杂场景处理困难
   - 改进：结合语义分割、深度学习

6. **参数依赖**
   - 不同场景需要调整参数
   - 改进：自适应参数选择、参数学习

### 改进方向

1. **预处理增强**

   - 直方图均衡化
   - 自适应阈值
   - 色彩空间转换（如 HSV，提取白色/黄色车道线）

2. **检测方法改进**

   - 使用 RANSAC 进行鲁棒拟合
   - 多尺度检测
   - 结合车道线颜色信息

3. **后处理优化**

   - 使用卡尔曼滤波平滑车道线
   - 多帧信息融合
   - 车道线跟踪

4. **深度学习方向**
   - 使用语义分割网络（如 U-Net）分割车道线
   - 端到端学习（如 LaneNet）
   - 结合传统方法和深度学习的混合方法

## 实验总结

本实验成功实现了基于霍夫变换的车道线检测系统，掌握了传统计算机视觉方法的基本流程。通过调整参数，可以在不同场景下获得较好的检测效果。但传统方法存在对光照、遮挡、弯道等场景的局限性，在实际应用中可考虑结合深度学习方法进行改进。
